import { gql } from '@apollo/client'
import { GetStaticProps } from 'next'
import Head from 'next/head'
import Link from 'next/link'
import clsx from 'clsx'
import { useRouter } from 'next/router'

import { Content } from '../components/Content'
import { ToggleTheme } from '../components/ToggleTheme'

import { client } from '../services/client'
import { Logo } from '../components/Logo'

export interface CreatedBy {
  name: string
}

export interface ServerSideDataProps {
  posts: {
    createdBy: CreatedBy
    readingTime: string
    tags: string[]
    title: string
    preview: string
    slug: string
    id: string
  }[]
}

export default function Home({ posts }: ServerSideDataProps) {
  const { route } = useRouter()

  return (
    <>
      <Head>
        <title>ANDRES - More than {posts.length - 1} posts.</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Content>
        <header className="flex items-center justify-between mt-10 mb-20">
          <Logo />

          <section className="flex flex-row items-center gap-x-10">
            <Link
              href="/"
              className={clsx(
                'hidden sm:flex text-sm hover:text-zinc-900 dark:hover:text-zinc-200',
                {
                  'dark:text-white text-zinc-900': route === '/',
                },
              )}
            >
              CODE
            </Link>

            <Link
              href="/work"
              className={clsx(
                'hidden sm:flex text-sm hover:text-zinc-900 dark:hover:text-zinc-200',
                {
                  'text-zinc-900': route === '/work',
                },
              )}
            >
              WORK
            </Link>

            <Link
              href="/learning"
              className={clsx(
                'hidden sm:flex text-sm hover:text-zinc-900 dark:hover:text-zinc-200',
                {
                  'text-zinc-900': route === '/work',
                },
              )}
            >
              WHAT AM I STUDYING?
            </Link>

            <ToggleTheme />
          </section>
        </header>

        <ul className="grid grid-cols-2 gap-5">
          {posts.map((post) => (
            <li key={post.id} className="before:content-['']">
              <Link href={encodeURI(`post/${post.slug}`)}>
                <h5 className="text-2xl font-light tracking-tight">
                  {post.title}
                </h5>

                <section className="flex items-center mt-5">
                  {post.tags.map((item) => (
                    <span
                      key={item}
                      className="first:rounded-l-lg last:border-none border-r dark:border-zinc-700/50 last:rounded-r-lg text-xs py-2 px-4 dark:bg-neutral-800 bg-zinc-100"
                    >
                      {item}
                    </span>
                  ))}
                </section>
              </Link>
            </li>
          ))}
        </ul>
      </Content>
    </>
  )
}

export const getStaticProps: GetStaticProps = async () => {
  const gqlResponse = await client
    .query({
      query: gql`
        query GetAllPosts {
          posts {
            createdBy {
              name
            }
            readingTime
            tags
            title
            preview
            slug
            id
          }
        }
      `,
    })
    .then((res) => {
      console.log(res)
      return res
    })
    .catch((err) => {
      console.log(err, 'error on your side')
      return err
    })

  return {
    props: gqlResponse ? gqlResponse.data : {},
  }
}
